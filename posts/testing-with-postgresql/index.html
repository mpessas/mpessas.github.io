<!DOCTYPE html>
<html><head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <title>Testing with PostgreSQL - That&#39;s weird...</title>

    
    
    <meta name="description" content="Transifex is a quite big application, counting tens of thousands of lines of Python, javascript and HTML code. In order to make sure the code works, it has an extensive test suite, which, obviously, takes quite some time to run.
There are various things that can be done to make tests run faster. But let&rsquo;s talk about databases.
Transifex is built on top of Django and uses its ORM. As a result, it can use various database backends, like SQLite and PostgreSQL." />
    <meta name="author" content="" />
    

    <link href="https://unpkg.com/@master/normal.css" rel="stylesheet">
    <script src="https://unpkg.com/@master/style@1.5.0"></script>
    <script src="https://unpkg.com/@master/styles@1.13.0"></script>
    <script src="https://unpkg.com/master-styles-group"></script>
    <script src="https://unpkg.com/themes.js"></script>
    <script>window.themes = window.themes || new window.Themes()</script>

    <style>
        :root {
            --font-sans: "Inter var", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;
        }
    </style></head>
<body class="bg:fade-84@dark font:fade-16@dark font:sans">
    <nav class="w:full h:90 fixed bg:fade-84/.95@dark bg:white z:1000">
    <div class="
        h:full
        w:full
        max-w:1200
        mx:auto
        px:32
        d:flex
        align-items:center
    ">
        <div>
            <a href="https://blog.bessas.me/" class="mr-3 font:extralight">
              
              That&#39;s weird...
              
            </a>
        </div>

        <div class="ml:auto">
            
            
            
        </div>
    </div>
</nav>
<div class="d:flex flex:column@<=sm pt:90 px:24 jc:center gap:44 word-break:break-word">
        <div class="max-w:700 w:full box:content-box">
<article class="box:border-box pt:32">
    <header class="mb:32">
        <div class="font:40 font:extrabold">Testing with PostgreSQL</div>
        <div class="mt:16 f:fade-60">
            <time>Jan 6, 2012</time>
            </div>
    </header><div class="
    _:where(a):hover{text-decoration-color:fade}
    _:where(a){text-decoration:2;underline;fade-10;_text-decoration-color:fade-70@dark}
    _:where(blockquote){bl:5;solid;fade-76/.1;_bl:5;solid;fade-34/.1@dark}
    _:where(code){font:90%;_v:middle}
    _:where(code:not(.highlight_*,pre_*)){p:2;6;_r:4}
    _:where(del){text-decoration:1;line-through;fade-68;_text-decoration-color:red-64@dark}
    _:where(figcaption){text:14;_p:10;20;0;_width:fit;_mx:auto;_font:fade-56;_font:fade-57@dark}
    _:where(h1){font:40;_font:extrabold}
    _:where(h1,h2,h3)+:where(h1,h2,h3){mt:.5em}
    _:where(h1,h2,h3,h4,h5,h6){mt:2em}
    _:where(h2){mb:1em;_font:32}
    _:where(h3){font:24}
    _:where(h4){font:20}
    _:where(h5){font:16}
    _:where(h6){font:14}
    _:where(li)::marker{font:fade-44;_font:fade-68@dark}
    _:where(li){pl:.375em}
    _:where(mark){text-decoration:1;underline;#fce016;_bg:transparent;_text-decoration-color:rgb(252;224;22/.5)@dark}
    _:where(p,li){font:fade-76;_font:16;_line-height:1.65;_font:fade-34@dark}
    _:where(p,pre,blockquote,figure,ul,ol,table){my:1.125em}
    >:first-child{mt:0!}
    _:where(pre){p:20;_r:8;_overflow:auto}
    _:where(pre,code:not(.highlight_*)){bg:fade-2;_bg:fade-92!@dark}
    _:where(strong,b,a,code:not(.highlight_*),mark,del){font:fade-92;_font:fade-12@dark}
    _:where(table){width:full;_border-spacing:0}
    _:where(td){v:baseline}
    _:where(td,th):first-child{pl:0}
    _:where(td,th):last-child{pr:0}
    _:where(td,th){bb:1;solid;fade-92/.06;_p:6;_b:fade-4/.04@dark}
    _:where(th){font:fade-78;_font:14;_text:left;_font:fade-12@dark}
    _:where(th,p_code,li_code,a,mark){font:semibold;_font:medium@dark}
    _:where(ul){list-style-type:disc}
    _:where(ul,ol,blockquote){pl:1.5em}
    _:where(video,img){max-width:full}
    _:where(a,mark){text-underline-offset:3}
    _:where(hr){h:2;_bg:fade-10;_bg:fade-70@dark;_my:3em}
"><p>Transifex is a quite big application, counting tens of thousands of lines of Python, javascript and HTML code. In order to make sure the code works, it has an extensive test suite, which, obviously, takes quite some time to run.</p>
<p>There are various things that can be done to make tests run faster. But let&rsquo;s talk about databases.</p>
<p>Transifex is built on top of <a href="https://www.djangoproject.com">Django</a> and uses its ORM. As a result, it can use various database backends, like <a href="http://www.sqlite.org/">SQLite</a> and <a href="http://www.postgresql.org/">PostgreSQL</a>.</p>
<p>When Django is configured to use SQLite, it does a nice little trick when running the test suite; it creates the database in memory. As a result, database access is very fast, since there is no I/O, which results in reduced execution time for the tests.</p>
<p>For example, we run the test suite for the <em>projects</em> app of Transifex:</p>
<pre><code>time ./manage.py test projects
</code></pre>
<p>and the results are:</p>
<pre><code>real    2m52.429s
user    2m5.132s
sys     0m2.953s
</code></pre>
<p>For the <em>resources</em> app (the test suite of which is much bigger) the results are:</p>
<pre><code>real    6m29.072s
user    4m35.209s
sys     0m8.956s
</code></pre>
<p>Of course, the above numbers are not a benchmark, but just an indication of how long it takes to run those tests on a machine with 8GB of RAM.</p>
<p>However, <a href="https://www.transifex.net">Transifex.net</a> runs on PostgreSQL and all testing should be done with the setup that is used in production. For instance, PostgreSQL is much more strict about transaction semantics than SQLite and that affects many tests. That means, tests should be run against PostgreSQL.</p>
<p>But, the default setup of PostgreSQL is not optimized at all. In fact, the default settings are chosen, so that PostgreSQL can run on servers with as little as 64MB of RAM (or something like that).</p>
<p>With the default setup of PostgreSQL, the <em>projects</em> test suite runs in:</p>
<pre><code>real    4m40.891s
user    2m16.898s
sys     0m3.816s
</code></pre>
<p>and the <em>resources</em> app in</p>
<pre><code>real    10m7.483s
user    4m58.841s
sys     0m9.566s
</code></pre>
<p>Both running times are mush worse than those achieved, when using SQLite as database backend.</p>
<p>There are a few settings, however, which could be optimized to make PostgreSQL faster for testing. In my machine, I have</p>
<pre><code>shared_buffers = 512MB
work_mem = 16MB
fsync = off
synchronous_commit = off
wal_buffers = 64MB
checkpoint_segments = 36
checkpoint_timeout = 10min
random_page_cost = 2.0
effective_cache_size = 1024MB
</code></pre>
<p>The goal is to allow PostgreSQL to use much more memory and, as a result, to choose more efficient execution plans for the queries. For instance, we set the <code>work_mem</code> to 16MB, a value large enough (for the tests of Transifex), so that all <code>SORT</code> operations are executed in RAM.</p>
<p>At the same time, we try to reduce the I/O that PostgreSQL will perform. For example, we deactivate the <code>fsync</code> option, which instructs PostgreSQL to do a <code>fsync()</code> call, whenever it writes something to disk, and increase the <code>checkpoint_segments</code> option, which instructs PostgreSQL to flush data in larger intervals.</p>
<p>You can see what each option is for in the <a href="http://www.postgresql.org/docs/current/static/">manual of PostgreSQL</a>.</p>
<p>With the above settings, the execution times are:</p>
<pre><code>real    3m4.360s
user    2m14.458s
sys     0m3.360s
</code></pre>
<p>for the <em>projects</em> app and</p>
<pre><code>real    6m49.579s
user    4m49.101s
sys     0m9.256s
</code></pre>
<p>for the <em>resources</em> app, which are comparable to the ones obtained, when using SQLite.</p>
<p>The values chosen depend, of course, on the CPU and available memory you have. Additionally, some of the options (like <code>fsync</code>) should not be used in production.
Keep also in mind that you will probably need to increase the maximum size of a shared memory segment with the command</p>
<pre><code>sysctl -w kernel.shmmax=8589934592
</code></pre>
<p>in order to use the above settings (or add the new value in <code>/etc/sysctl.conf</code>).</p>
</div></article>
<footer class="py:24">
    <div class="f:fade-30 f:14 mb:8"></div>
    <div class="f:fade-60 f:12">Theme <a class="f:bold" href="https://github.com/serkodev/holy" _target="_blank">Holy</a></div>
</footer></div>
    </div>
</body>

</html>