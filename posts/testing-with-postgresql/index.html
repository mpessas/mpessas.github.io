<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    

    

    <link rel="icon" type="image/png" href="https://blog.bessas.me/favicon_16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://blog.bessas.me/favicon_32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://blog.bessas.me/favicon_128x128.png" sizes="128x128">

    <title>
      
      
         Testing with PostgreSQL 
      
    </title>
    <link rel="canonical" href="https://blog.bessas.me/posts/testing-with-postgresql/">

    <style>
  * {
    border:0;
    font:inherit;
    font-size:100%;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
  }

  body {
    font-family:'Open Sans', 'Myriad Pro', Myriad, sans-serif;
    font-size:17px;
    line-height:160%;
    color:#1d1313;
    max-width:700px;
    margin:auto;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify {
    float: left;
  }

  .right-justify {
    float:right;
  }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    font-size: 12px;
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    max-width: auto;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  .heading,.serif,h1,h2,h3 {
    font-family:"Old Standard TT",serif;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    font-size:35px;
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }

  h1 {
    font-size:35px;
  }

  h2 {
    font-size:28px;
  }

  h3 {
    font-size:22px;
    margin-top:18px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  #sub-header, time {
    color:#403c3b;
    font-size:13px;
  }

  #sub-header {
    margin: 0 4px;
  }

  #nav h1 a {
    font-size:35px;
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 5px;
  }

  ul li {
    list-style-type: none;
  }
  ul li:before {
    content:"\00BB \0020";
  }

  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    font-size:15px;
    padding:60px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content h2 {
    font-size:25px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content time {
    margin-left:3px;
  }

  #content h1 {
    font-size:30px;
  }

  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

  .posts_listing li a:hover,#nav a:hover {
    text-decoration: underline;
  }

  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  #nav ul {
    display: table;
    margin: 8px auto 0 auto;
  }

  #nav li {
    list-style-type:none;
    display:table-cell;
    font-size:15px;
    padding: 0 20px;
  }

  #links {
    margin: 50px 0 0 0;
  }

  #links :nth-child(2) {
    float:right;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-family:"Old Standard TT",serif;
    font-size: 200px;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
  }

  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 15px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 10px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }
</style>


    
  </head>

  <body>
    <section id=nav>
      <h1><a href="https://blog.bessas.me/">That&#39;s weird...</a></h1>
      <ul>
        
          <li><a href="https://github.com/mpessas/">Github</a></li>
        
      </ul>
    </section>


<section id=content>
  <h1> Testing with PostgreSQL </h1>

  
    <div id=sub-header>
      January 2012 Â· 3 minute read
    </div>
  

  <div class="entry-content">
    <p>Transifex is a quite big application, counting tens of thousands of lines of Python, javascript and HTML code. In order to make sure the code works, it has an extensive test suite, which, obviously, takes quite some time to run.</p>

<p>There are various things that can be done to make tests run faster. But let&rsquo;s talk about databases.</p>

<p>Transifex is built on top of <a href="https://www.djangoproject.com">Django</a> and uses its ORM. As a result, it can use various database backends, like <a href="http://www.sqlite.org/">SQLite</a> and <a href="http://www.postgresql.org/">PostgreSQL</a>.</p>

<p>When Django is configured to use SQLite, it does a nice little trick when running the test suite; it creates the database in memory. As a result, database access is very fast, since there is no I/O, which results in reduced execution time for the tests.</p>

<p>For example, we run the test suite for the <em>projects</em> app of Transifex:</p>

<pre><code>time ./manage.py test projects
</code></pre>

<p>and the results are:</p>

<pre><code>real    2m52.429s
user    2m5.132s
sys     0m2.953s
</code></pre>

<p>For the <em>resources</em> app (the test suite of which is much bigger) the results are:</p>

<pre><code>real    6m29.072s
user    4m35.209s
sys     0m8.956s
</code></pre>

<p>Of course, the above numbers are not a benchmark, but just an indication of how long it takes to run those tests on a machine with 8GB of RAM.</p>

<p>However, <a href="https://www.transifex.net">Transifex.net</a> runs on PostgreSQL and all testing should be done with the setup that is used in production. For instance, PostgreSQL is much more strict about transaction semantics than SQLite and that affects many tests. That means, tests should be run against PostgreSQL.</p>

<p>But, the default setup of PostgreSQL is not optimized at all. In fact, the default settings are chosen, so that PostgreSQL can run on servers with as little as 64MB of RAM (or something like that).</p>

<p>With the default setup of PostgreSQL, the <em>projects</em> test suite runs in:</p>

<pre><code>real    4m40.891s
user    2m16.898s
sys     0m3.816s
</code></pre>

<p>and the <em>resources</em> app in</p>

<pre><code>real    10m7.483s
user    4m58.841s
sys     0m9.566s
</code></pre>

<p>Both running times are mush worse than those achieved, when using SQLite as database backend.</p>

<p>There are a few settings, however, which could be optimized to make PostgreSQL faster for testing. In my machine, I have</p>

<pre><code>shared_buffers = 512MB
work_mem = 16MB
fsync = off
synchronous_commit = off
wal_buffers = 64MB
checkpoint_segments = 36
checkpoint_timeout = 10min
random_page_cost = 2.0
effective_cache_size = 1024MB
</code></pre>

<p>The goal is to allow PostgreSQL to use much more memory and, as a result, to choose more efficient execution plans for the queries. For instance, we set the <code>work_mem</code> to 16MB, a value large enough (for the tests of Transifex), so that all <code>SORT</code> operations are executed in RAM.</p>

<p>At the same time, we try to reduce the I/O that PostgreSQL will perform. For example, we deactivate the <code>fsync</code> option, which instructs PostgreSQL to do a <code>fsync()</code> call, whenever it writes something to disk, and increase the <code>checkpoint_segments</code> option, which instructs PostgreSQL to flush data in larger intervals.</p>

<p>You can see what each option is for in the <a href="http://www.postgresql.org/docs/current/static/">manual of PostgreSQL</a>.</p>

<p>With the above settings, the execution times are:</p>

<pre><code>real    3m4.360s
user    2m14.458s
sys     0m3.360s
</code></pre>

<p>for the <em>projects</em> app and</p>

<pre><code>real    6m49.579s
user    4m49.101s
sys     0m9.256s
</code></pre>

<p>for the <em>resources</em> app, which are comparable to the ones obtained, when using SQLite.</p>

<p>The values chosen depend, of course, on the CPU and available memory you have. Additionally, some of the options (like <code>fsync</code>) should not be used in production.
Keep also in mind that you will probably need to increase the maximum size of a shared memory segment with the command</p>

<pre><code>sysctl -w kernel.shmmax=8589934592
</code></pre>

<p>in order to use the above settings (or add the new value in <code>/etc/sysctl.conf</code>).</p>

  </div>

  <div id=links>
    
      <a class="basic-alignment left" href="https://blog.bessas.me/posts/timedrotatingfilehandler/">&laquo; TimedRotatingFileHandler</a>
    
    
      <a class="basic-alignment left" href="https://blog.bessas.me/posts/transifex-optimize-download/">Optimizing the operation of downloading files in Transifex &raquo;</a>
    
  </div>
</section>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-26208931-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>



